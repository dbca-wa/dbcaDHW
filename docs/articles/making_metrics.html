<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Making metrics • dbcaDHW</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Making metrics">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dbcaDHW</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dbca-wa/dbcaDHW/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Making metrics</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dbca-wa/dbcaDHW/blob/HEAD/vignettes/making_metrics.Rmd" class="external-link"><code>vignettes/making_metrics.Rmd</code></a></small>
      <div class="hidden name"><code>making_metrics.Rmd</code></div>

    </div>

    
    
<p><img src="plots%2FdbcaDHWlogo2011.png"></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The aim of this vignette is to show a method of creating some useful
SST metrics from daily data.</p>
<p>By following the vignette <strong>Using dbcaDHW</strong> there will
be a csv of SST values and a folder structure that this analysis will
utilise. Please read that vignette first if you haven’t done so.</p>
</div>
<div class="section level2">
<h2 id="raster-creation">Raster creation<a class="anchor" aria-label="anchor" href="#raster-creation"></a>
</h2>
<p>The metrics created are best stored in rasters to maintain their
spatial relationship and can always be re-extracted depending on the
need. In raster format they are also in a handy format for
visualisation.</p>
<p>First up load up other required packages, read in the previously
created data and set up a few useful objects.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rgdal</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## read in extracted daily values</span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"CRW3_1_extract_yourstartdate_yourfinishdate_SST_data.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## sites</span></span>
<span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">g_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sites</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span></code></pre></div>
<p>Next up transform into a long format, create some new variables and
remove leap days. This analysis will be based on 365 days in a year so
we don’t need the complexity of including the 29th of February when it
rolls around. Also set up a data frame to house all the results prior to
writing rasters.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## wide to long and remove leap days</span></span>
<span><span class="va">ndata</span> <span class="op">&lt;-</span> <span class="va">dataset</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="st">"temp"</span>, <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">g_num</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">dates</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>                month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">dates</span>, <span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>                day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">dates</span>, <span class="fl">9</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">!=</span> <span class="st">"02"</span> <span class="op">|</span> <span class="va">day</span> <span class="op">!=</span> <span class="st">"29"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## set up output data frame</span></span>
<span><span class="va">outdf</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>Id <span class="op">=</span> <span class="va">sites</span>, </span>
<span>                    hot_mean <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    num_over <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                    mtemp_over <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                    strks_over <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    lstrk_over <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    max <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Right, with the setup complete, loop over each site (which is a pixel
through time) and define a <strong>past</strong> and
<strong>present</strong> period. The user will have to input appropriate
dates in the filter arguments below. The dates below are those used in
the paper.</p>
<p>There is a neat gotcha below. Pay attention to the creation of the
<strong>nday</strong> variable. We need to number all the days of each
year consecutively in order to create a grouping variable so that we can
compare all 1st of Januarys to each other etc. So if your data set
starts on the 1st of January then its OK to start numbering from 1.
However as can be seen in the creation of the <strong>present</strong>
data set in which the period starts on the 1st of August, the numbering
needed to start at 213. This all depends on what data the user has to
analyse and what they define as a <strong>present</strong> starting
date. Please choose appropriately.</p>
<p>In the <strong>past</strong> data set, also create an average
temperature (e.g. average temperature for all 1st of Januarys etc). A
number of metrics are then created and stored in the output data
frame:</p>
<ul>
<li>hottest mean - <strong>past</strong> period.</li>
<li>number over - total number of days in <strong>present</strong>
period over the hottest mean temperature.</li>
<li>max temperature over - degrees difference between maximum
temperature in <strong>present</strong> period and hottest mean.</li>
<li>streaks over - number of times the <strong>present</strong> period
temperature exceeded the hottest mean for at least 5 consecutive days.
If 5 days is not appropriate , change in the code below.</li>
<li>longest streak - length in days of the longest streak of
temperatures in <strong>present</strong> period over the hottest mean
for at least 5 consecutive days. If 5 days is not appropriate , change
in the code below.</li>
<li>max temperature - the hottest temperature in the
<strong>present</strong> period.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">sites</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Processing "</span>, <span class="va">sites</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"...\n"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## define past period - UPDATE WHEN NEW DATA</span></span>
<span>  <span class="va">past</span> <span class="op">&lt;-</span> <span class="va">ndata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dates</span> <span class="op">&lt;</span> <span class="st">"2010-08-01"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">site</span> <span class="op">==</span> <span class="va">sites</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>nday <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">365</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co">#gotta match first start date</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">nday</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## define present period</span></span>
<span>  <span class="va">present</span> <span class="op">&lt;-</span> <span class="va">ndata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dates</span> <span class="op">&gt;=</span> <span class="st">"2010-08-01"</span> <span class="op">&amp;</span> <span class="va">dates</span> <span class="op">&lt;=</span> <span class="st">"2011-07-31"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">site</span> <span class="op">==</span> <span class="va">sites</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>nday <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">213</span><span class="op">:</span><span class="fl">365</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">212</span><span class="op">)</span><span class="op">)</span> <span class="co">#gotta match first start date</span></span>
<span>  </span>
<span>  <span class="co">## hottest mean</span></span>
<span>  <span class="va">hot_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">past</span><span class="op">$</span><span class="va">avg</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># present temps indicating which higher than threshold</span></span>
<span>  <span class="va">presenthighs</span> <span class="op">&lt;-</span> <span class="va">present</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>overthresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">&gt;</span> <span class="va">hot_mean</span>, <span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## rle</span></span>
<span>  <span class="va">streak</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rle.html" class="external-link">rle</a></span><span class="op">(</span><span class="va">presenthighs</span><span class="op">$</span><span class="va">overthresh</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## number and lengths of streaks - CHANGE IF 5 DAYS NOT APPROPRIATE</span></span>
<span>  <span class="va">streakdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sval <span class="op">=</span> <span class="va">streak</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         slgth <span class="op">=</span> <span class="va">streak</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sval</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="va">slgth</span> <span class="op">&gt;=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## number over hottest mean</span></span>
<span>  <span class="va">num_over</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">streakdf</span><span class="op">$</span><span class="va">slgth</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## max temp over hottest mean</span></span>
<span>  <span class="va">mtemp_over</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">present</span><span class="op">$</span><span class="va">temp</span><span class="op">)</span> <span class="op">-</span> <span class="va">hot_mean</span></span>
<span>  </span>
<span>  <span class="co">## num streaks above hottest mean</span></span>
<span>  <span class="va">strks_over</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">streakdf</span><span class="op">$</span><span class="va">slgth</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## longest streak over hottest mean</span></span>
<span>  <span class="va">lstrk_over</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">streakdf</span><span class="op">$</span><span class="va">slgth</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## fill output data frame</span></span>
<span>  <span class="va">outdf</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">hot_mean</span></span>
<span>  <span class="va">outdf</span><span class="op">[</span><span class="va">i</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">num_over</span></span>
<span>  <span class="va">outdf</span><span class="op">[</span><span class="va">i</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mtemp_over</span></span>
<span>  <span class="va">outdf</span><span class="op">[</span><span class="va">i</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">strks_over</span></span>
<span>  <span class="va">outdf</span><span class="op">[</span><span class="va">i</span>, <span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lstrk_over</span></span>
<span>  <span class="va">outdf</span><span class="op">[</span><span class="va">i</span>, <span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">present</span><span class="op">$</span><span class="va">temp</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now its time to write all of these results to rasters. Use one of the
existing img files to use as a template (sets up cell resolution, crs
etc) and also write all of these results to the extraction shape
file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## grab example of orig SST img raster to use as template</span></span>
<span><span class="va">temp_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></span><span class="op">(</span><span class="st">"./img_data/1985/b5km_sst_v3.1_19850101.img"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## grab extraction shape file to add to</span></span>
<span><span class="va">e_pts</span> <span class="op">&lt;-</span> <span class="fu">readOGR</span><span class="op">(</span>dsn <span class="op">=</span> <span class="st">"."</span>, layer <span class="op">=</span> <span class="st">"extraction_pts_3577"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## add new metrics to extraction shape file</span></span>
<span><span class="va">e_pts</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">e_pts</span><span class="op">@</span><span class="va">data</span>, <span class="va">outdf</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">e_pts</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">Id</span>, <span class="va">outdf</span><span class="op">$</span><span class="va">Id</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create a folder for output rasters</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="st">"./sst_metrics"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"./sst_metrics"</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="co">## write out rasters</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">e_pts</span>, y <span class="op">=</span> <span class="va">temp_raster</span>, field <span class="op">=</span> <span class="st">"num_over"</span>,</span>
<span>          filename <span class="op">=</span> <span class="st">"./SST_metrics/num_threshold_temp_over_3577.img"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">e_pts</span>, y <span class="op">=</span> <span class="va">temp_raster</span>, field <span class="op">=</span> <span class="st">"mtemp_over"</span>,</span>
<span>          filename <span class="op">=</span> <span class="st">"./SST_metrics/max_temp_over_3577.img"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">e_pts</span>, y <span class="op">=</span> <span class="va">temp_raster</span>, field <span class="op">=</span> <span class="st">"strks_over"</span>,</span>
<span>          filename <span class="op">=</span> <span class="st">"./SST_metrics/number_strks_over_3577.img"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">e_pts</span>, y <span class="op">=</span> <span class="va">temp_raster</span>, field <span class="op">=</span> <span class="st">"lstrk_over"</span>,</span>
<span>          filename <span class="op">=</span> <span class="st">"./SST_metrics/longest_strk_over_3577.img"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">e_pts</span>, y <span class="op">=</span> <span class="va">temp_raster</span>, field <span class="op">=</span> <span class="st">"hot_mean"</span>,</span>
<span>          filename <span class="op">=</span> <span class="st">"./SST_metrics/hot_mean_temp_3577.img"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">e_pts</span>, y <span class="op">=</span> <span class="va">temp_raster</span>, field <span class="op">=</span> <span class="st">"max"</span>,</span>
<span>          filename <span class="op">=</span> <span class="st">"./SST_metrics/max_temp_3577.img"</span><span class="op">)</span></span></code></pre></div>
<p>With the data stored as rasters they can easily be turned into
visualisations by adding in some additional vectors representing regions
and coastlines etc.</p>
<p><img src="plots%2Fmax-over.png"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Bart Huntley.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
